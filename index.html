<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Verval PJU TS ESDM ‚Äì Barito Timur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body{font-family:Arial;margin:0;background:#0b1220;color:#fff}
header{background:#0f1b35;padding:12px;text-align:center;font-weight:bold}
.container{padding:10px}
select,input,textarea,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:none;box-sizing:border-box}
button{background:#00c2ff;color:#000;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{border:1px solid #444;padding:6px}
th{background:#12244b}
tr.active{background:#2b7cff;color:#fff}
#map{height:360px;margin-top:10px;border-radius:10px}
.readonly{background:#222;color:#aaa}
.hidden{display:none}
.box{background:#141f3d;padding:10px;border-radius:10px;margin-top:12px}
</style>
</head>
<body>

<header>‚úÖ SISTEM VERIFIKASI LAPANGAN PJU TS ESDM ‚Äì BARITO TIMUR</header>
<div class="container">

<label>Pilih Tahun Perolehan</label>
<select id="tahunSelect">
<option value="">-- Pilih Tahun --</option>
<option>2021</option><option>2022</option><option>2023</option>
</select>

<div class="box">
<b>Data Target ESDM</b>
<table id="tabelEsdm">
<thead>
<tr>
  <th>ID</th>
  <th>Kecamatan</th>
  <th>Desa/Lokasi</th>
  <th>Koordinat (Google Maps)</th>
  <th>Status</th>
  <th>Wawancara</th>
  <th>Catatan Fisik</th>
  <th>Foto</th>
  <th>Waktu Simpan</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="map"></div>
<button onclick="ambilLokasi()">üìç Ambil Posisi Saya</button>
<input id="latManual" placeholder="Latitude">
<input id="lngManual" placeholder="Longitude">
<button onclick="prosesManual()">Proses Manual</button>

<div class="box hidden" id="formVerval">
<b>Form Verifikasi</b>
<input id="rowIndex" class="readonly" readonly>
<input id="id_barang" class="readonly" readonly>
<input id="petugas" placeholder="Petugas">
<select id="status_fisik"><option>Baik</option><option>Rusak</option><option>Hilang</option></select>
<textarea id="catatan"></textarea>
<label>Upload Foto</label>
<input type="file" id="foto_verval" accept="image/*" capture>
<button onclick="kirimVerval()">üíæ SIMPAN</button>
</div>

<div class="box">
<b>‚úÖ Data Hasil Verifikasi</b>
<table id="tabelVerval">
<thead>
<tr><th>ID</th><th>Lokasi</th><th>Status</th><th>Petugas</th></tr>
</thead><tbody></tbody>
</table>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SCRIPT_URL="PASTE_URL_APPSCRIPT_MU_DI_SINI";

let map=L.map('map').setView([-2.13,115.10],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let dataESDM=[],markerSaya,layerESDM=L.layerGroup().addTo(map);

const iconESDM=L.icon({iconUrl:'./esdm.png',iconSize:[32,32]});
const iconBARTIM=L.icon({iconUrl:'./bartim.png',iconSize:[36,36]});

function parseAngka(x){return parseFloat(String(x).replace(",", "."));}

tahunSelect.onchange=loadTahun;

function loadTahun(){
fetch(`${SCRIPT_URL}?action=listByYear&year=${tahunSelect.value}`)
.then(r=>r.json()).then(d=>{dataESDM=d.data||[];renderTabel();renderPeta();});
}

function renderTabel(){
let html="";
dataESDM.forEach(r=>{
let link=`<a href="https://maps.google.com?q=${r.lat_awal},${r.lng_awal}" target="_blank">${r.lat_awal},${r.lng_awal}</a>`;
let fotoLink = r.link_foto_verval 
  ? `<a href="${r.link_foto_verval}" target="_blank">üì∑ Lihat</a>` 
  : "-";

html+=`<tr id="row${r.rowIndex}">
  <td>${r.id_barang||""}</td>
  <td>${r.nama_kecamatan||""}</td>
  <td>${r.nama_desa_lokasi||""}</td>
  <td>${linkMap}</td>
  <td>${r.status_validasi||""}</td>
  <td>${r.keterangan_wawancara||""}</td>
  <td>${r.catatan_fisik||""}</td>
  <td>${fotoLink}</td>
  <td>${r.waktu_simpan||""}</td>
</tr>`;

});
tabelEsdm.querySelector("tbody").innerHTML=html;
}

function renderPeta(){
layerESDM.clearLayers();
dataESDM.forEach(d=>{
let lat=parseAngka(d.lat_awal),lng=parseAngka(d.lng_awal);
if(!isNaN(lat)&&!isNaN(lng)){
let m=L.marker([lat,lng],{icon:iconESDM}).addTo(layerESDM);
m.on("click",()=>{rowIndex.value=d.rowIndex;id_barang.value=d.id_barang;formVerval.classList.remove("hidden");});
}});
}

function ambilLokasi(){
navigator.geolocation.getCurrentPosition(p=>{
if(markerSaya)map.removeLayer(markerSaya);
markerSaya=L.marker([p.coords.latitude,p.coords.longitude],{icon:iconBARTIM}).addTo(map);
});
}

function prosesManual(){
ambilLokasi();
}

function kirimVerval(){
const file=document.getElementById("foto_verval").files[0];
if(!file)return alert("Foto wajib!");

let reader=new FileReader();
reader.onload=function(){
let payload={
action:"verval_esdm",
rowIndex:rowIndex.value,
id_barang:id_barang.value,
petugas_verval:petugas.value,
status_fisik:status_fisik.value,
catatan_fisik:catatan.value,
foto_base64:reader.result.split(",")[1],
foto_nama:file.name
};

fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(payload)})
.then(r=>r.json()).then(d=>{alert(d.message);loadVerval();});
};
reader.readAsDataURL(file);
}

function loadVerval(){
fetch(`${SCRIPT_URL}?action=listVerval`).then(r=>r.json()).then(d=>{
let html="";
(d.data||[]).forEach(r=>{
html+=`<tr><td>${r.id_barang}</td><td>${r.nama_desa_lokasi}</td><td>${r.status_validasi}</td><td>${r.petugas_verval}</td></tr>`;
});
tabelVerval.querySelector("tbody").innerHTML=html;
});
}
loadVerval();
</script>
</body>
</html>
