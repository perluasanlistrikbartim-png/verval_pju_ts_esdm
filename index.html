<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VERVAL PJU TS ESDM ‚Ä¢ Barito Timur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body{margin:0;background:#0a0f1c;color:#e8edff;font-family:'Segoe UI',sans-serif;}
header{padding:16px;text-align:center;background:#111a33;border-bottom:2px solid #1e2f55;
  box-shadow:0 0 15px #0ff3 inset;color:#9fd5ff;font-weight:bold;}
.container{padding:14px;max-width:900px;margin:auto;}
select,input,textarea,button{
  width:100%;padding:10px;border-radius:8px;margin-top:8px;border:none;
  font-size:15px;background:#162038;color:#cfe7ff;}
button{background:#1abfff;color:#001;font-weight:bold;cursor:pointer;transition:.2s;}
button:hover{box-shadow:0 0 10px #00e5ff;}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px;}
th,td{border:1px solid #234;padding:6px;}
th{background:#162850;color:#aee2ff;}
tr.updated{animation:updatedBlink 1.2s ease-out;}
@keyframes updatedBlink{0%{background:#3aff85;}100%{background:transparent;}}
.box{background:#111c33;padding:12px;border-radius:12px;margin-top:16px;
  box-shadow:0 0 10px #0ff3 inset;}
.hidden{display:none}
.readonly{background:#0e1629;color:#8ca3c7;}
#map{height:350px;margin-top:12px;border-radius:12px;
  box-shadow:0 0 12px #00eaff44;}
#loading{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;
  display:flex;align-items:center;justify-content:center;z-index:9999;visibility:hidden;}
.spinner{width:60px;height:60px;border:8px solid #49dfff44;border-top-color:#00eaff;
  border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>

<body>
<div id="loading"><div class="spinner"></div></div>

<header>VERIFIKASI & VALIDASI PJU TS ‚Äì BARITO TIMUR</header>

<div class="container">

<label>Pilih Tahun Perolehan</label>
<select id="tahunSelect">
  <option value="">-- Pilih Tahun --</option>
  <option>2021</option>
  <option>2022</option>
  <option>2023</option>
</select>

<button onclick="reloadHalaman()" style="background:#22e6a7;margin-top:8px">
  üîÑ Reload Halaman
</button>

<div class="box">
  <b>DATA TARGET ESDM</b>
  <table id="tabelEsdm">
    <thead>
      <tr>
        <th>ID</th><th>Kecamatan</th><th>Desa</th><th>Koordinat</th>
        <th>Status</th><th>Wawancara</th><th>Catatan</th><th>Foto</th><th>Waktu</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="map"></div>

<button onclick="ambilLokasi()">üìç Ambil Posisi GPS</button>

<label>Input Koordinat Manual</label>
<input id="latManual" placeholder="Latitude">
<input id="lngManual" placeholder="Longitude">
<button onclick="prosesManual()">Proses Manual</button>

<div class="box hidden" id="formVerval">
  <b>FORM VERVAL</b>

  <input id="rowIndex" class="readonly" readonly placeholder="Row Index">
  <input id="id_barang" class="readonly" readonly placeholder="ID Barang">
  <input id="nama_kecamatan" placeholder="Nama Kecamatan">
  <input id="nama_desa_lokasi" placeholder="Nama Desa/Lokasi">

  <input id="lat_awal" class="readonly" readonly placeholder="Lat Awal">
  <input id="lng_awal" class="readonly" readonly placeholder="Lng Awal">

  <input id="lat_verval" class="readonly" readonly placeholder="Lat Verval">
  <input id="lng_verval" class="readonly" readonly placeholder="Lng Verval">

  <input id="petugas" placeholder="Petugas Verifikasi">
  <input id="status_validasi" class="readonly" readonly placeholder="Status Validasi">
  <input id="jarak" class="readonly" readonly placeholder="Jarak (meter)">

  <select id="status_fisik">
    <option value="">Status Fisik</option>
    <option>Baik</option><option>Rusak</option><option>Hilang</option>
  </select>

  <input id="nama_narasumber" placeholder="Nama Narasumber">
  <textarea id="ket_wawancara" placeholder="Hasil Wawancara"></textarea>
  <textarea id="catatan" placeholder="Catatan Lapangan"></textarea>

  <label>Upload Foto</label>
  <input type="file" id="foto_verval" accept="image/*" capture="environment">

  <button id="btnSimpan" onclick="kirimVerval()">üíæ SIMPAN VERVAL</button>
</div>

<div class="box">
  <b>DATA HASIL VERVAL</b>
  <table id="tabelVerval">
    <thead>
      <tr><th>ID</th><th>Lokasi</th><th>Status</th><th>Petugas</th><th>Foto</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ====================== CONFIG ====================== */
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbzz7URJnz_3tqSCv2i-rUt4cgkFHwI6pH7JRidzSwkzczTIUlUO5f0NGs7yMCZZOvDTgg/exec";

const PROXY = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";

/* ====================== SPINNER ====================== */
function showLoad(){ loading.style.visibility="visible"; }
function hideLoad(){ loading.style.visibility="hidden"; }

/* ====================== MAP ====================== */
let map = L.map('map').setView([-2.13,115.10],10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let cacheTahun = {};
let markerSaya;
let layerESDM = L.layerGroup().addTo(map);

/* ====================== DEBOUNCE ====================== */
let tahunTimeout = null;
tahunSelect.onchange = function(){
  clearTimeout(tahunTimeout);
  tahunTimeout = setTimeout(loadTahun, 250);
};

/* ====================== LOAD TAHUN ====================== */
function loadTahun(){
  const tahun = tahunSelect.value;
  if(!tahun){ tabelEsdm.querySelector("tbody").innerHTML=""; return; }

  if(cacheTahun[tahun]){
    renderTabel(cacheTahun[tahun]);
    renderPeta(cacheTahun[tahun]);
    return;
  }

  showLoad();

  const url = encodeURIComponent(SCRIPT_URL + "?action=listByYear&year=" + tahun);

  fetch(PROXY + url)
    .then(r=>r.json())
    .then(j=>{
      hideLoad();
      cacheTahun[tahun] = j.data;
      renderTabel(j.data);
      renderPeta(j.data);
    })
    .catch(err=>{
      hideLoad();
      alert("‚ùå Gagal load data: " + err);
    });
}

/* ====================== RENDER TABEL ====================== */
function renderTabel(list){
  let html="";
  list.forEach(r=>{
    html+=`
      <tr id="row${r.rowIndex}">
        <td>${r.id_barang}</td>
        <td>${r.nama_kecamatan}</td>
        <td>${r.nama_desa_lokasi}</td>
        <td>${r.lat_awal}, ${r.lng_awal}</td>
        <td>${r.status_validasi||""}</td>
        <td>${r.keterangan_wawancara||""}</td>
        <td>${r.catatan_fisik||""}</td>
        <td>${r.link_foto_verval?`<a href="${r.link_foto_verval}" target="_blank">üì∑</a>`:"-"}</td>
        <td>${r.waktu_simpan||""}</td>
      </tr>`;
  });
  tabelEsdm.querySelector("tbody").innerHTML = html;
}

/* ====================== RENDER MAP ====================== */
function renderPeta(list){
  layerESDM.clearLayers();
  list.forEach(r=>{
    if(!r.lat_awal || !r.lng_awal) return;
    L.marker([r.lat_awal, r.lng_awal])
      .addTo(layerESDM)
      .on("click",()=> pilihTitik(r));
  });
}

/* ====================== PILIH TITIK ====================== */
function pilihTitik(d){
  formVerval.classList.remove("hidden");

  id_barang.value = d.id_barang;
  nama_kecamatan.value = d.nama_kecamatan;
  nama_desa_lokasi.value = d.nama_desa_lokasi;
  rowIndex.value = d.rowIndex;
  lat_awal.value = d.lat_awal;
  lng_awal.value = d.lng_awal;

  highlight(d.rowIndex);
}

function highlight(i){
  const tr = document.getElementById("row"+i);
  if(!tr) return;
  tr.classList.add("updated");
  setTimeout(()=> tr.classList.remove("updated"), 1200);
}

/* ====================== MANUAL / GPS ====================== */
function ambilLokasi(){
  if(!navigator.geolocation) return alert("GPS tidak tersedia.");
  navigator.geolocation.getCurrentPosition(pos=>{
    prosesTitik(pos.coords.latitude, pos.coords.longitude);
  });
}

function prosesManual(){
  const a=parseFloat(latManual.value), b=parseFloat(lngManual.value);
  if(isNaN(a)||isNaN(b)) return alert("Koordinat tidak valid.");
  prosesTitik(a,b);
}

function prosesTitik(lat,lng){
  if(markerSaya) map.removeLayer(markerSaya);
  markerSaya = L.marker([lat,lng]).addTo(map);
  map.setView([lat,lng],17);
  lat_verval.value = lat;
  lng_verval.value = lng;
}

/* ====================== KIRIM VERVAL ====================== */
async function kirimVerval(){

  btnSimpan.disabled = true;
  btnSimpan.innerText = "‚è≥ Menyimpan...";

  const file = foto_verval.files[0];
  if(!file){ alert("Foto wajib!"); resetBtn(); return; }

  const base64 = await new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.readAsDataURL(file);
  });

  const data = {
    action:"verval",
    rowIndex: rowIndex.value,
    id_barang: id_barang.value,
    nama_kecamatan: nama_kecamatan.value,
    nama_desa_lokasi: nama_desa_lokasi.value,
    lat_awal: lat_awal.value,
    lng_awal: lng_awal.value,
    lat_verval: lat_verval.value,
    lng_verval: lng_verval.value,
    petugas_verval: petugas.value,
    status_validasi: status_validasi.value,
    status_fisik: status_fisik.value,
    nama_narasumber: nama_narasumber.value,
    ket_wawancara: ket_wawancara.value,
    catatan_fisik: catatan.value,
    fotoBase64: base64,
    jarak: jarak.value
  };

  showLoad();

  const url = encodeURIComponent(SCRIPT_URL);

  const res = await fetch(PROXY + url, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });

  hideLoad();

  const j = await res.json();
  alert(j.message || "Selesai");

  resetBtn();
  loadVerval();
}

function resetBtn(){
  btnSimpan.disabled=false;
  btnSimpan.innerText="üíæ SIMPAN VERVAL";
}

/* ====================== LOAD DATA VERVAL ====================== */
function loadVerval(){
  const url = encodeURIComponent(SCRIPT_URL + "?action=listVerval");

  fetch(PROXY + url)
    .then(r=>r.json())
    .then(j=>{
      let html="";
      j.data.forEach(r=>{
        html+=`
          <tr>
            <td>${r.id_barang}</td>
            <td>${r.nama_desa_lokasi}</td>
            <td>${r.status_validasi}</td>
            <td>${r.petugas_verval}</td>
            <td>${r.link_foto_verval?`<a href="${r.link_foto_verval}" target="_blank">üì∑</a>`:"-"}</td>
          </tr>`;
      });
      tabelVerval.querySelector("tbody").innerHTML = html;
    });
}

loadVerval();

/* ====================== RELOAD ====================== */
function reloadHalaman(){ location.reload(); }

</script>

</body>
</html>
