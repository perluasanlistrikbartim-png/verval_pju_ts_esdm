<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° VERVAL PJU TS KEMENTERIAN ESDM RI (TAHUN 2021, 2022, & 2023)‚Äî Kabupaten Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
/* ============================================================
   === PREMIUM MAX LIGHTNING UI ‚Äî DARK NEON INTERFACE ===
============================================================ */

body {
  margin: 0;
  background: radial-gradient(circle at center, #020216, #000010 70%, #000000);
  color: #e0f7ff;
  font-family: 'Segoe UI', sans-serif;
  overflow-x: hidden;
  position: relative;
}

/* ELECTRIC BACKGROUND */
#electricFX {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  opacity: .55;
  z-index: 0;
}

/* HEADER */
header {
  padding: 22px;
  text-align: center;
  background: linear-gradient(180deg, #021428, #000814 70%, #000);
  border-bottom: 2px solid #00eaff55;
  box-shadow: 0 0 25px #00eaff33 inset, 0 0 40px #0088ff22;
  position: relative;
  z-index: 5;
}

.header-flex {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 35px;
}

.logo-esdm, .logo-bartim {
  width: 85px;
  height: 85px;
  border-radius: 6px;
  background: #002233;
  padding: 6px;
  box-shadow: 0 0 20px #00eaff66;
  animation: glowLogo 6s ease-in-out infinite;
}
@keyframes glowLogo {
  0%,100% { filter: drop-shadow(0 0 10px #00eaff); }
  50% { filter: drop-shadow(0 0 25px #00eaffaa); }
}

.header-title {
  font-size: 1.6rem;
  font-weight: bold;
  text-shadow: 0 0 12px #00eaff, 0 0 25px #00aaff;
  margin-top: 10px;
}

.header-sub {
  font-size: 0.95rem;
  color: #a8deff;
  margin-top: 6px;
  text-shadow: 0 0 8px #0099ff88;
}

/* CONTAINER */
.container {
  padding: 15px;
  max-width: 960px;
  margin: auto;
  position: relative;
  z-index: 2;
}

/* INPUTS */
select, input, textarea, button {
  width: 100%;
  padding: 11px;
  border-radius: 10px;
  margin-top: 8px;
  border: none;
  font-size: 15px;
  background: #071a33;
  color: #cfefff;
  box-shadow: 0 0 12px #00eaff22 inset;
}
button {
  background: linear-gradient(90deg, #00eaff, #0088ff);
  color: #001;
  font-weight: bold;
  cursor: pointer;
  transition: 0.18s;
}
button:hover {
  box-shadow: 0 0 15px #00eaffcc;
  transform: translateY(-2px);
}

/* BOX */
.box {
  background: #071427cc;
  padding: 15px;
  border-radius: 14px;
  box-shadow: 0 0 20px #00eaff33 inset, 0 0 30px #0088ff22;
  margin-top: 18px;
}

/* TABLE */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 13px;
}
th, td {
  border: 1px solid #0c2b44;
  padding: 7px;
}
th {
  background: #0b2442;
  color: #aee7ff;
}
tr.updated {
  animation: blinkUpdate 1.2s ease-out;
}
@keyframes blinkUpdate {
  0% { background: #18ff9c; }
  100% { background: transparent; }
}

/* MAP */
#map {
  height: 360px;
  margin-top: 15px;
  border-radius: 14px;
  box-shadow: 0 0 20px #00eaff44;
}

/* LOADING SPINNER */
#loading {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: #001018dd;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  visibility: hidden;
}
.spinner {
  width: 70px;
  height: 70px;
  border: 8px solid #00eaff44;
  border-top-color: #00eaff;
  border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.readonly { background:#061325;color:#89a8c7; }
.hidden { display:none; }

</style>
</head>

<body>

<canvas id="electricFX"></canvas>

<div id="loading"><div class="spinner"></div></div>

<header>
  <div class="header-flex">
    <img src="esdm.png" class="logo-esdm">
    <div>
      <div class="header-title">‚ö° VERVAL PJU TS KEMENTERIAN ESDM RI 2021, 2022, & 2023‚Äì BARITO TIMUR ‚ö°</div>
      <div class="header-sub">Dinas PUPRPERKIM (2021 & 2023)‚Ä¢ Dishub (2022)</div>
    </div>
    <img src="bartim.png" class="logo-bartim">
  </div>
</header>

<div class="container">

<label>Pilih Tahun Perolehan</label>
<select id="tahunSelect">
  <option value="">-- Pilih Tahun --</option>
  <option>2021</option>
  <option>2022</option>
  <option>2023</option>
</select>

<button onclick="reloadHalaman()" style="background:#22e6a7;margin-top:10px">üîÑ Reload Halaman</button>

<div class="box">
  <b>DATA TARGET ESDM</b>
  <table id="tabelEsdm">
    <thead>
      <tr>
        <th>ID</th>
        <th>Kecamatan</th>
        <th>Desa</th>
        <th>Koordinat</th>
        <th>Status</th>
        <th>Wawancara</th>
        <th>Catatan</th>
        <th>Foto</th>
        <th>Waktu</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="map"></div>

<button onclick="ambilLokasi()">üìç Ambil Posisi GPS</button>

<label>Input Koordinat Manual</label>
<input id="latManual" placeholder="Latitude">
<input id="lngManual" placeholder="Longitude">
<button onclick="prosesManual()">Proses Manual</button>

<div class="box hidden" id="formVerval">
  <b>FORM VERVAL</b>

  <input id="rowIndex" class="readonly" readonly placeholder="Row Index">
  <input id="id_barang" class="readonly" readonly placeholder="ID Barang">
  <input id="nama_kecamatan" placeholder="Nama Kecamatan">
  <input id="nama_desa_lokasi" placeholder="Nama Desa/Lokasi">

  <input id="lat_awal" class="readonly" readonly placeholder="Lat Awal">
  <input id="lng_awal" class="readonly" readonly placeholder="Lng Awal">

  <input id="lat_verval" class="readonly" readonly placeholder="Lat Verval">
  <input id="lng_verval" class="readonly" readonly placeholder="Lng Verval">

  <input id="petugas" placeholder="Petugas Verifikasi">
  <input id="status_validasi" class="readonly" readonly placeholder="Status Validasi">
  <input id="jarak" class="readonly" readonly placeholder="Jarak (meter)">

  <select id="status_fisik">
    <option value="">Status Fisik</option>
    <option>Baik</option>
    <option>Rusak</option>
    <option>Hilang</option>
  </select>

  <input id="nama_narasumber" placeholder="Nama Narasumber">
  <textarea id="ket_wawancara" placeholder="Hasil Wawancara"></textarea>
  <textarea id="catatan" placeholder="Catatan Lapangan"></textarea>

  <label>Upload Foto</label>
  <input type="file" id="foto_verval" accept="image/*" capture="environment">

  <button id="btnSimpan" onclick="kirimVerval()">üíæ SIMPAN VERVAL</button>
</div>

<div class="box">
  <b>DATA HASIL VERVAL</b>
  <table id="tabelVerval">
    <thead>
      <tr>
        <th>ID</th>
        <th>Lokasi</th>
        <th>Status</th>
        <th>Petugas</th>
        <th>Foto</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ============================================================
   ‚ö° KONFIGURASI
============================================================ */
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbzz7URJnz_3tqSCv2i-rUt4cgkFHwI6pH7JRidzSwkzczTIUlUO5f0NGs7yMCZZOvDTgg/exec";

const PROXY =
  "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";

function showLoad(){ loading.style.visibility="visible"; }
function hideLoad(){ loading.style.visibility="hidden"; }

/* ============================================================
   ‚ö° MAP LEAFLET
============================================================ */
let map = L.map('map').setView([-2.13,115.10], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
  .addTo(map);

let cacheTahun = {};
let markerSaya;
let layerESDM = L.layerGroup().addTo(map);

/* ============================================================
   ‚ö° CUSTOM ICON ESDM & BARTIM
============================================================ */
const iconEsdm = L.icon({
  iconUrl: "https://raw.githubusercontent.com/perluasanlistrikbartim-png/verval_pju_ts_esdm/main/esdm.png",
  iconSize: [42, 42],
  iconAnchor: [21, 42],
  className: "icon-esdm"
});

const iconBartim = L.icon({
  iconUrl: "https://raw.githubusercontent.com/perluasanlistrikbartim-png/verval_pju_ts_esdm/main/bartim.png",
  iconSize: [42, 42],
  iconAnchor: [21, 42],
  className: "icon-bartim"
});

/* glow */
const glowCSS = document.createElement("style");
glowCSS.innerHTML = `
  .icon-esdm { filter: drop-shadow(0 0 8px #00eaff) drop-shadow(0 0 16px #0088ff); }
  .icon-bartim { filter: drop-shadow(0 0 8px #00ff88) drop-shadow(0 0 16px #00dd66); }
`;
document.head.appendChild(glowCSS);

/* ============================================================
   ‚ö° DEBOUNCE PILIH TAHUN
============================================================ */
let tahunTimeout = null;

tahunSelect.onchange = function(){
  clearTimeout(tahunTimeout);
  tahunTimeout = setTimeout(loadTahun, 250);
};

/* ============================================================
   ‚ö° LOAD DATA PER TAHUN ‚Äî FIX
============================================================ */
function loadTahun(){
  const tahun = tahunSelect.value;

  if(!tahun){
    tabelEsdm.querySelector("tbody").innerHTML = "";
    return;
  }

  if(cacheTahun[tahun]){
    renderTabel(cacheTahun[tahun]);
    renderPeta(cacheTahun[tahun]);
    return;
  }

  showLoad();

  const url = `${SCRIPT_URL}?action=listByYear&year=${tahun}`;

  fetch(PROXY + encodeURIComponent(url))
    .then(res => res.json())
    .then(j => {
      hideLoad();
      cacheTahun[tahun] = j.data;
      renderTabel(j.data);
      renderPeta(j.data);
    })
    .catch(err => {
      hideLoad();
      alert("‚ùå Gagal load data: " + err);
    });
}

/* ============================================================
   ‚ö° RENDER TABEL
============================================================ */
function renderTabel(list){
  let html = "";

  list.forEach(r => {

    const mapsLink =
      r.lat_awal && r.lng_awal
        ? `<a style="color:#4ae2ff" href="https://maps.google.com/?q=${r.lat_awal},${r.lng_awal}" target="_blank">üìç ${r.lat_awal}, ${r.lng_awal}</a>`
        : "-";

    html += `
      <tr id="row${r.rowIndex}">
        <td>${r.id_barang}</td>
        <td>${r.nama_kecamatan}</td>
        <td>${r.nama_desa_lokasi}</td>
        <td>${mapsLink}</td>
        <td>${r.status_validasi || ""}</td>
        <td>${r.keterangan_wawancara || ""}</td>
        <td>${r.catatan_fisik || ""}</td>
        <td>${r.link_foto_verval ? `<a href="${r.link_foto_verval}" target="_blank">üì∑</a>` : "-"}</td>
        <td>${r.waktu_simpan || ""}</td>
      </tr>`;
  });

  tabelEsdm.querySelector("tbody").innerHTML = html;
}

/* ============================================================
   ‚ö° RENDER PETA
============================================================ */
function renderPeta(list){
  layerESDM.clearLayers();

  list.forEach(r => {
    if(!r.lat_awal || !r.lng_awal) return;

    L.marker([r.lat_awal, r.lng_awal], { icon: iconEsdm })
      .addTo(layerESDM)
      .on("click", () => pilihTitik(r));
  });
}

/* ============================================================
   ‚ö° PILIH TITIK ‚Üí TAMPILKAN FORM
============================================================ */
function pilihTitik(d){
  formVerval.classList.remove("hidden");

  id_barang.value        = d.id_barang;
  nama_kecamatan.value   = d.nama_kecamatan;
  nama_desa_lokasi.value = d.nama_desa_lokasi;
  rowIndex.value         = d.rowIndex;

  lat_awal.value = d.lat_awal;
  lng_awal.value = d.lng_awal;

  highlightRow(d.rowIndex);
}

function highlightRow(i){
  const tr = document.getElementById("row" + i);
  if(!tr) return;
  tr.classList.add("updated");
  setTimeout(() => tr.classList.remove("updated"), 1200);
}

/* ============================================================
   ‚ö° GPS & MANUAL INPUT
============================================================ */
function ambilLokasi(){
  if(!navigator.geolocation) return alert("GPS tidak tersedia.");

  navigator.geolocation.getCurrentPosition(pos => {
    prosesTitik(pos.coords.latitude, pos.coords.longitude);
  });
}

function prosesManual(){
  const lat = parseFloat(latManual.value);
  const lng = parseFloat(lngManual.value);

  if(isNaN(lat) || isNaN(lng)) return alert("Koordinat tidak valid.");
  prosesTitik(lat, lng);
}

function prosesTitik(lat, lng){
  if(markerSaya) map.removeLayer(markerSaya);

  markerSaya = L.marker([lat, lng], { icon: iconBartim }).addTo(map);
  map.setView([lat, lng], 17);

  lat_verval.value = lat;
  lng_verval.value = lng;

  hitungJarak();

  /* === FIX SUPER PENTING ===
     Jika user belum pilih titik ESDM ‚Üí tidak ada data
  */
  if(!rowIndex.value){
    alert("‚ö† Pilih dulu titik ESDM sebelum memasukkan lokasi verval.");
    return;
  }

  /* === AUTO TAMPILKAN FORM VERVAL === */
  formVerval.classList.remove("hidden");
}


/* ============================================================
   ‚ö° HITUNG JARAK
============================================================ */
function hitungJarak(){
  if(!lat_verval.value || !lng_verval.value) return;

  let lat1 = parseFloat(lat_awal.value);
  let lon1 = parseFloat(lng_awal.value);
  let lat2 = parseFloat(lat_verval.value);
  let lon2 = parseFloat(lng_verval.value);

  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const d = R * c;

  jarak.value = Math.round(d) + " m";
}

/* ============================================================
   ‚ö° KIRIM VERVAL ‚Äî FIX
============================================================ */
async function kirimVerval(){

  btnSimpan.disabled = true;
  btnSimpan.innerText = "‚è≥ Menyimpan...";

  const file = foto_verval.files[0];
  if(!file){
    alert("Foto verval wajib diupload!");
    resetBtn();
    return;
  }

  const base64 = await new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.readAsDataURL(file);
  });

  const payload = {
    action: "verval",
    rowIndex: rowIndex.value,
    id_barang: id_barang.value,
    nama_kecamatan: nama_kecamatan.value,
    nama_desa_lokasi: nama_desa_lokasi.value,
    lat_awal: lat_awal.value,
    lng_awal: lng_awal.value,
    lat_verval: lat_verval.value,
    lng_verval: lng_verval.value,
    petugas_verval: petugas.value,
    status_validasi: status_validasi.value,
    status_fisik: status_fisik.value,
    nama_narasumber: nama_narasumber.value,
    ket_wawancara: ket_wawancara.value,
    catatan_fisik: catatan.value,
    fotoBase64: base64,

    /* wajib sesuai script apps script */
    jarak_selisih_meter: jarak.value.replace(" m",""),
    akurasi_gps_meter: 5,
    metode_verifikasi: "Visual GPS"
  };

  showLoad();

  const url = SCRIPT_URL;

  const res = await fetch(PROXY + encodeURIComponent(url), {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  hideLoad();

  const j = await res.json();
  alert(j.message || "Berhasil disimpan");

  resetBtn();
  loadVerval();
}

function resetBtn(){
  btnSimpan.disabled = false;
  btnSimpan.innerText = "üíæ SIMPAN VERVAL";
}

/* ============================================================
   ‚ö° LOAD DATA VERVAL ‚Äî FIX
============================================================ */
function loadVerval(){
  const url =
    `${SCRIPT_URL}?action=listVerval`;

  fetch(PROXY + encodeURIComponent(url))
    .then(res => res.json())
    .then(j => {
      let html = "";
      j.data.forEach(r => {
        html += `
          <tr>
            <td>${r.id_barang}</td>
            <td>${r.nama_desa_lokasi}</td>
            <td>${r.status_validasi}</td>
            <td>${r.petugas_verval}</td>
            <td>${r.link_foto_verval ? `<a href="${r.link_foto_verval}" target="_blank">üì∑</a>` : "-"}</td>
          </tr>`;
      });
      tabelVerval.querySelector("tbody").innerHTML = html;
    });
}

loadVerval();

/* ============================================================
   ‚ö° RELOAD
============================================================ */
function reloadHalaman(){ location.reload(); }

</script>





<!-- ============================================================
     ‚ö° FOOTER PREMIUM
============================================================ -->
<footer style="
  margin-top:40px;
  padding:15px;
  text-align:center;
  background:#0b1222;
  border-top:2px solid #113366;
  color:#7fc7ff;
  font-weight:bold;
  text-shadow:0 0 10px #0088ff;
  box-shadow:0 0 18px #00d9ff55 inset;
">
  ¬© 2025 ‚Äî VERVAL PJU TS ‚Ä¢ Dinas Pertambangan & Energi ESDM Barito Timur
</footer>


</body>
</html>
