<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš¡ VERVAL PJU TS ESDM â€” BARITO TIMUR</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body{margin:0;background:#020216;color:#e0f7ff;font-family:Segoe UI}
header{padding:18px;text-align:center;background:#000814}
.container{padding:15px;max-width:960px;margin:auto}
select,input,textarea,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:none}
button{background:#00eaff;font-weight:bold;cursor:pointer}
.box{background:#071427;padding:12px;border-radius:12px;margin-top:15px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #0c2b44;padding:6px}
th{background:#0b2442}
#map{height:360px;margin-top:12px;border-radius:12px}
.hidden{display:none}
tr.selected{background:#18ff9c33}
</style>
</head>

<body>

<header>
  <h2>âš¡ VERVAL PJU TS ESDM BARITO TIMUR</h2>
</header>

<div class="container">

<select id="tahunSelect">
  <option value="">-- Pilih Tahun --</option>
  <option>2021</option>
  <option>2022</option>
  <option>2023</option>
</select>

<div class="box">
<b>DATA TARGET ESDM</b>
<table id="tabelEsdm">
<thead>
<tr>
<th>ID</th><th>Kecamatan</th><th>Desa</th><th>Status</th><th>Foto</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="map"></div>

<div class="box hidden" id="formVerval">
<b>FORM VERVAL</b>
<input id="rowIndex" readonly>
<input id="lat_awal" readonly>
<input id="lng_awal" readonly>
<input id="lat_verval" readonly>
<input id="lng_verval" readonly>
<input id="petugas" placeholder="Petugas">
<select id="status_fisik">
  <option>Baik</option>
  <option>Rusak</option>
  <option>Hilang</option>
</select>
<input type="file" id="foto_verval" accept="image/*">
<button onclick="kirimVerval()">ðŸ’¾ SIMPAN</button>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbx5nShJ4GUDFNMS24CuaqewhpTepFjzT3wsmi7-UJJiy8ZwgdYsRe0CATPuNuvdh_2T-g/exec";

const tahunSelect=document.getElementById("tahunSelect");
const tabel=document.querySelector("#tabelEsdm tbody");
const form=document.getElementById("formVerval");

const rowIndex=document.getElementById("rowIndex");
const lat_awal=document.getElementById("lat_awal");
const lng_awal=document.getElementById("lng_awal");
const lat_verval=document.getElementById("lat_verval");
const lng_verval=document.getElementById("lng_verval");
const petugas=document.getElementById("petugas");
const status_fisik=document.getElementById("status_fisik");
const foto_verval=document.getElementById("foto_verval");

const map=L.map("map").setView([-2.13,115.10],10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const layer=L.layerGroup().addTo(map);

const iconEsdm=L.icon({iconUrl:"esdm.png",iconSize:[40,40],iconAnchor:[20,40]});
const iconBartim=L.icon({iconUrl:"bartim.png",iconSize:[40,40],iconAnchor:[20,40]});
const iconTemuan=L.icon({iconUrl:"temuan.png",iconSize:[36,36],iconAnchor:[18,36]});

tahunSelect.onchange=loadData;

async function loadData(){
  const y=tahunSelect.value;
  if(!y)return;
  tabel.innerHTML="";
  layer.clearLayers();

  const res=await fetch(`${SCRIPT_URL}?year=${y}`);
  const j=await res.json();

  j.data.forEach(r=>{
    if(r.tipe==="ESDM"){
      tabel.innerHTML+=`
      <tr onclick='pilih(${JSON.stringify(r)})'>
        <td>${r.id_barang||""}</td>
        <td>${r.nama_kecamatan||""}</td>
        <td>${r.nama_desa_lokasi||""}</td>
        <td>${r.status_validasi||""}</td>
        <td>${r.link_foto_verval?`<a href="${r.link_foto_verval}" target="_blank">ðŸ“·</a>`:""}</td>
      </tr>`;

      if(!isNaN(r.lat_awal)&&!isNaN(r.lng_awal))
        L.marker([r.lat_awal,r.lng_awal],{icon:iconEsdm}).addTo(layer);

      if(!isNaN(r.lat_verval)&&!isNaN(r.lng_verval))
        L.marker([r.lat_verval,r.lng_verval],{icon:iconBartim}).addTo(layer);
    }

    if(r.tipe==="TEMUAN"){
      L.marker([r.lat,r.lng],{icon:iconTemuan}).addTo(layer)
        .bindTooltip("TEMUAN "+r.tahun);
    }
  });
}

function pilih(r){
  form.classList.remove("hidden");
  rowIndex.value=r.rowIndex;
  lat_awal.value=r.lat_awal;
  lng_awal.value=r.lng_awal;
}

map.on("click",e=>{
  lat_verval.value=e.latlng.lat.toFixed(6);
  lng_verval.value=e.latlng.lng.toFixed(6);
});

async function kirimVerval(){
  const f=foto_verval.files[0];
  const fr=new FileReader();
  fr.onload=async()=>{
    const payload={
      rowIndex:rowIndex.value,
      status_validasi:"TERVERIFIKASI",
      petugas_verval:petugas.value,
      lat_verval:lat_verval.value,
      lng_verval:lng_verval.value,
      status_fisik:status_fisik.value,
      metode_verifikasi:"Lapangan",
      fotoBase64:fr.result
    };
    await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(payload)});
    alert("âœ” Tersimpan");
    loadData();
  };
  fr.readAsDataURL(f);
}
</script>

</body>
</html>
