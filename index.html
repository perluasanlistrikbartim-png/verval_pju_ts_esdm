<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Verval PJU TS ESDM ‚Äì Barito Timur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body{font-family:Arial;margin:0;background:#0b1220;color:#fff}
header{background:#0f1b35;padding:12px;text-align:center;font-weight:bold}
.container{padding:10px}
select,input,textarea,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:none}
button{background:#00c2ff;color:#000;font-weight:bold;cursor:pointer}
button:hover{opacity:0.9}

table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{border:1px solid #444;padding:6px;text-align:left}
th{background:#12244b}
tr.active{background:#2b7cff;color:#fff}
#map{height:320px;margin-top:10px;border-radius:10px}

.readonly{background:#222}
.hidden{display:none}
.box{background:#141f3d;padding:10px;border-radius:10px;margin-top:12px}
</style>
</head>

<body>

<header>
‚úÖ SISTEM VERIFIKASI LAPANGAN PJU TS ESDM ‚Äì BARITO TIMUR
</header>

<div class="container">

<!-- PILIH TAHUN -->
<label>Pilih Tahun Perolehan</label>
<select id="tahunSelect"></select>

<!-- TABEL DATA ESDM -->
<div class="box">
<b>Data Target ESDM (Read Only)</b>
<table id="tabelEsdm">
<thead>
<tr>
<th>ID</th>
<th>Kecamatan</th>
<th>Desa/Lokasi</th>
<th>Lat</th>
<th>Lng</th>
<th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- PETA -->
<div id="map"></div>

<button onclick="ambilLokasi()">üìç Ambil Posisi Saya</button>

<label>Atau Input Koordinat Manual</label>
<input id="latManual" placeholder="Latitude">
<input id="lngManual" placeholder="Longitude">
<button onclick="prosesManual()">Proses Koordinat</button>

<!-- FORM VERVAL -->
<div class="box hidden" id="formVerval">
<b>Form Verifikasi Lapangan</b>

<input id="tahun" class="readonly" readonly>
<input id="id_barang" class="readonly" readonly>

<input id="nama_kecamatan">
<input id="nama_desa_lokasi">

<input id="lat_awal" class="readonly" readonly>
<input id="lng_awal" class="readonly" readonly>

<input id="lat_verval" class="readonly" readonly>
<input id="lng_verval" class="readonly" readonly>

<input id="jarak" class="readonly" readonly>
<input id="status_validasi" class="readonly" readonly>

<input id="petugas" placeholder="Petugas Verifikasi">

<select id="status_fisik">
<option value="">Status Fisik</option>
<option>Baik</option>
<option>Rusak</option>
<option>Hilang</option>
</select>

<select id="metode">
<option value="">Metode Verifikasi</option>
<option>Visual</option>
<option>Wawancara</option>
</select>

<input id="narasumber" placeholder="Nama Narasumber">
<textarea id="ket_wawancara" placeholder="Keterangan Wawancara"></textarea>
<textarea id="catatan" placeholder="Catatan Fisik"></textarea>

<button onclick="kirimVerval()">üíæ SIMPAN VERVAL</button>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxJ4ynM5FieQC8w5zVairtshkDoWOgyxnryEUSsx8cT3xH6rSGyKZsENeviu1a9E4JrZg/exec";

let dataESDM = [];
let map = L.map('map').setView([-2.13,115.10], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let markerSaya, markerESDM;

fetch(`${SCRIPT_URL}?action=listYears`).then(r=>r.json()).then(d=>{
  tahunSelect.innerHTML = d.years.map(y=>`<option>${y}</option>`).join('');
  loadTahun();
});

function loadTahun(){
  fetch(`${SCRIPT_URL}?action=listByYear&year=${tahunSelect.value}`)
  .then(r=>r.json()).then(d=>{
    dataESDM = d.data;
    renderTabel();
    renderPeta();
  });
}
tahunSelect.onchange = loadTahun;

function renderTabel(){
  let tb = "";
  dataESDM.forEach(r=>{
    tb += `<tr id="row${r.rowIndex}">
      <td>${r.id_barang}</td>
      <td>${r.nama_kecamatan||""}</td>
      <td>${r.nama_desa_lokasi||""}</td>
      <td>${r.lat_awal}</td>
      <td>${r.lng_awal}</td>
      <td>${r.status_validasi||""}</td>
    </tr>`;
  });
  tabelEsdm.querySelector("tbody").innerHTML = tb;
}

function renderPeta(){
  if(markerESDM) markerESDM.clearLayers();
  markerESDM = L.layerGroup().addTo(map);
  dataESDM.forEach(d=>{
    L.marker([d.lat_awal,d.lng_awal]).addTo(markerESDM);
  });
}

function ambilLokasi(){
  navigator.geolocation.getCurrentPosition(pos=>{
    prosesTitik(pos.coords.latitude, pos.coords.longitude);
  });
}

function prosesManual(){
  prosesTitik(
    parseFloat(latManual.value),
    parseFloat(lngManual.value)
  );
}

function prosesTitik(lat, lng){
  if(markerSaya) map.removeLayer(markerSaya);
  markerSaya = L.marker([lat,lng]).addTo(map);
  map.setView([lat,lng],17);

  let terdekat = null, jarakMin = 999999;

  dataESDM.forEach(d=>{
    let j = hitungJarak(lat,lng,d.lat_awal,d.lng_awal);
    if(j < jarakMin){
      jarakMin = j;
      terdekat = d;
    }
  });

  document.getElementById("formVerval").classList.remove("hidden");

  if(jarakMin <= 100){
    isiFormESDM(terdekat,lat,lng,jarakMin);
  }else{
    isiFormNonESDM(lat,lng);
  }
}

function isiFormESDM(d,lat,lng,jarak){
  tahun.value = tahunSelect.value;
  id_barang.value = d.id_barang;
  nama_kecamatan.value = d.nama_kecamatan;
  nama_desa_lokasi.value = d.nama_desa_lokasi;
  nama_kecamatan.readOnly = true;
  nama_desa_lokasi.readOnly = true;

  lat_awal.value = d.lat_awal;
  lng_awal.value = d.lng_awal;
  lat_verval.value = lat;
  lng_verval.value = lng;
  jarak.value = jarak.toFixed(1);
  status_validasi.value = jarak < 30 ? "Valid" : "Suspect";
}

function isiFormNonESDM(lat,lng){
  tahun.value = "NON-ESDM";
  id_barang.value = "";
  nama_kecamatan.readOnly = false;
  nama_desa_lokasi.readOnly = false;
  lat_awal.value = "";
  lng_awal.value = "";
  lat_verval.value = lat;
  lng_verval.value = lng;
  jarak.value = "";
  status_validasi.value = "Non-ESDM";
}

function hitungJarak(a,b,c,d){
  const R=6371000,rad=Math.PI/180;
  let dLat=(c-a)*rad,dLng=(d-b)*rad;
  let x=Math.sin(dLat/2)**2+Math.cos(a*rad)*Math.cos(c*rad)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function kirimVerval(){
  let payload={
    action: status_validasi.value==="Non-ESDM"?"temuan_lapangan":"verval_esdm",
    tahun_perolehan_aset_esdm: tahun.value,
    id_barang: id_barang.value,
    petugas_verval: petugas.value,
    koordinat_verval_lat: lat_verval.value,
    koordinat_verval_lng: lng_verval.value,
    status_fisik: status_fisik.value,
    metode_verifikasi: metode.value,
    nama_narasumber: narasumber.value,
    keterangan_wawancara: ket_wawancara.value,
    catatan_fisik: catatan.value
  };

  fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(payload)})
  .then(r=>r.json()).then(d=>{
    alert(d.message);
    location.reload();
  });
}
</script>

</body>
</html>
