<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Verval PJU TS ESDM ‚Äì Barito Timur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body{
  font-family: Arial, sans-serif;
  margin:0;
  background:#0b1220;
  color:#fff;
}
header{
  background:#0f1b35;
  padding:12px;
  text-align:center;
  font-weight:bold;
}
.container{padding:10px}

select,input,textarea,button{
  width:100%;
  padding:8px;
  margin-top:6px;
  border-radius:6px;
  border:none;
  box-sizing:border-box;
}
button{
  background:#00c2ff;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
button:hover{opacity:0.9}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:13px;
}
th,td{
  border:1px solid #444;
  padding:6px;
}
th{background:#12244b}
tr.active{background:#2b7cff;color:#fff}

#map{
  height:360px;
  margin-top:10px;
  border-radius:10px;
}

.readonly{
  background:#222;
  color:#aaa;
}
.hidden{display:none}
.box{
  background:#141f3d;
  padding:10px;
  border-radius:10px;
  margin-top:12px;
}

/* mobile tweak */
@media (max-width:600px){
  table{font-size:11px}
  th,td{padding:4px}
}
.footer{
  margin-top:20px;
  padding:12px;
  text-align:center;
  font-size:12px;
  color:#cfd8ff;
  background:#0f1b35;
  border-top:1px solid #1f2d55;
}
</style>
</head>

<body>

<header>
  ‚úÖ SISTEM VERIFIKASI DAN VALIDASI PJU TS ESDM ‚Äì BARITO TIMUR<br>
  <span style="font-size:12px; font-weight:normal; color:#cfd8ff;">
    Sinergi DPUPRPERKIM Kabupaten Barito Timur Tahun 2021 & 2023<br>
    Bersama DISHUB Kabupaten Barito Timur Tahun 2022
  </span>
</header>

<div class="container">

<!-- PILIH TAHUN -->
<label>Pilih Tahun Perolehan</label>
<select id="tahunSelect">
  <option value="">-- Pilih Tahun --</option>
  <option>2021</option>
  <option>2022</option>
  <option>2023</option>
</select>

<button onclick="reloadHalaman()" style="margin-top:8px;background:#21e6a7;">
  üîÑ Reload Halaman
</button>

<!-- DATA TARGET ESDM -->
<div class="box">
  <b>Data Target ESDM</b>
  <table id="tabelEsdm">
    <thead>
      <tr>
        <th>ID</th>
        <th>Kecamatan</th>
        <th>Desa/Lokasi</th>
        <th>Koordinat</th>
        <th>Status</th>
        <th>Wawancara</th>
        <th>Catatan Fisik</th>
        <th>Foto</th>
        <th>Waktu Simpan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- PETA -->
<div id="map"></div>

<button onclick="ambilLokasi()">üìç Ambil Posisi Saya</button>

<label>Atau Input Koordinat Manual</label>
<input id="latManual" placeholder="Latitude (desimal)">
<input id="lngManual" placeholder="Longitude (desimal)">
<button onclick="prosesManual()">Proses Manual</button>

<!-- FORM VERVAL -->
<div class="box hidden" id="formVerval">
  <b>Form Verifikasi Lapangan</b>

  <input id="rowIndex" class="readonly" readonly placeholder="Row Index">
  <input id="id_barang" class="readonly" readonly placeholder="ID Barang">
  <input id="status_validasi" class="readonly" readonly placeholder="Status Validasi">
  <input id="jarak" class="readonly" readonly placeholder="Jarak ke Titik ESDM (m)">

  <input id="nama_kecamatan" placeholder="Nama Kecamatan">
  <input id="nama_desa_lokasi" placeholder="Nama Desa/Lokasi">

  <input id="lat_awal" class="readonly" readonly placeholder="Lat Awal ESDM">
  <input id="lng_awal" class="readonly" readonly placeholder="Lng Awal ESDM">

  <input id="lat_verval" class="readonly" readonly placeholder="Lat Verval">
  <input id="lng_verval" class="readonly" readonly placeholder="Lng Verval">

  <input id="petugas" placeholder="Petugas Verifikasi">

  <select id="status_fisik">
    <option value="">Status Fisik</option>
    <option>Baik</option>
    <option>Rusak</option>
    <option>Hilang</option>
  </select>

  <textarea id="catatan" placeholder="Catatan Fisik"></textarea>

  <label>Upload Foto Verval (Wajib)</label>
  <input type="file" id="foto_verval" accept="image/*" capture="environment">

  <button onclick="kirimVerval()">üíæ SIMPAN VERVAL</button>
</div>

<!-- DATA HASIL VERIFIKASI -->
<div class="box">
  <b>‚úÖ Data Hasil Verifikasi</b>
  <table id="tabelVerval">
    <thead>
      <tr>
        <th>ID</th>
        <th>Lokasi</th>
        <th>Status</th>
        <th>Petugas</th>
        <th>Foto</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzz7URJnz_3tqSCv2i-rUt4cgkFHwI6pH7JRidzSwkzczTIUlUO5f0NGs7yMCZZOvDTgg/exec";
const PROXY = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";

function reloadHalaman(){ location.reload(); }

let map = L.map('map').setView([-2.13,115.10],10);
  /* ======================= ICON ESDM & BARTIM ======================= */

const iconESDM = L.icon({
  iconUrl: 'esdm.png',      // ikon untuk titik data ESDM
  iconSize: [32, 32],
  iconAnchor: [16, 32],
  popupAnchor: [0, -32]
});

const iconBARTIM = L.icon({
  iconUrl: 'bartim.png',    // ikon lokasi verval petugas
  iconSize: [36, 36],
  iconAnchor: [18, 36],
  popupAnchor: [0, -36]
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let dataESDM = [];
let markerSaya;
let layerESDM = L.layerGroup().addTo(map);

function parseAngka(x){
  if(x==null) return NaN;
  return parseFloat(String(x).replace(",","."));
}

tahunSelect.onchange = loadTahun;

function loadTahun(){
  if(!tahunSelect.value){
    dataESDM = [];
    tabelEsdm.querySelector("tbody").innerHTML = "";
    layerESDM.clearLayers();
    return;
  }

  fetch(SCRIPT_URL + `?action=listByYear&year=${tahunSelect.value}`)
    .then(r=>r.json())
    .then(d=>{
      dataESDM = d.data || [];
      renderTabelESDM();
      renderPeta();
    })
    .catch(()=>alert("Gagal load data ESDM"));
}

function renderTabelESDM(){
  let html = "";
  dataESDM.forEach(r=>{
    const lat = parseAngka(r.lat_awal);
    const lng = parseAngka(r.lng_awal);

    let linkMap = (!isNaN(lat) && !isNaN(lng))
      ? `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color:#00c2ff;text-decoration:none">üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}</a>`
      : "-";

    let fotoLink = r.link_foto_verval
      ? `<a href="${r.link_foto_verval}" target="_blank">üì∑ Lihat</a>`
      : "-";

    html += `
      <tr id="row${r.rowIndex}">
        <td>${r.id_barang || ""}</td>
        <td>${r.nama_kecamatan || ""}</td>
        <td>${r.nama_desa_lokasi || ""}</td>
        <td>${linkMap}</td>
        <td>${r.status_validasi || ""}</td>
        <td>${r.keterangan_wawancara || ""}</td>
        <td>${r.catatan_fisik || ""}</td>
        <td>${fotoLink}</td>
        <td>${r.waktu_simpan || ""}</td>
      </tr>
    `;
  });
  tabelEsdm.querySelector("tbody").innerHTML = html;
}

function renderPeta(){
  layerESDM.clearLayers();
  dataESDM.forEach(d=>{
    const lat = parseAngka(d.lat_awal);
    const lng = parseAngka(d.lng_awal);
    if(!isNaN(lat) && !isNaN(lng)){
      const m = L.marker([lat,lng], { icon: iconESDM }).addTo(layerESDM);
      m.on("click",()=>{
        map.setView([lat,lng],15);
        tandaiBaris(d.rowIndex);
      });
    }
  });
}

function tandaiBaris(rowIndex){
  document.querySelectorAll("#tabelEsdm tbody tr").forEach(tr=>tr.classList.remove("active"));
  const tr = document.getElementById("row"+rowIndex);
  if(tr) tr.classList.add("active");
}
/* ===================== AMBIL & PROSES LOKASI ===================== */

function ambilLokasi(){
  if(!navigator.geolocation){
    alert("Geolocation tidak didukung perangkat ini.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    prosesTitik(pos.coords.latitude, pos.coords.longitude);
  },()=>{
    alert("Gagal mengambil lokasi GPS.");
  });
}

function prosesManual(){
  const lat = parseFloat(latManual.value);
  const lng = parseFloat(lngManual.value);
  if(isNaN(lat) || isNaN(lng)){
    alert("Koordinat manual tidak valid.");
    return;
  }
  prosesTitik(lat, lng);
}

function prosesTitik(lat, lng){
  if(markerSaya) map.removeLayer(markerSaya);
  markerSaya = L.marker([lat,lng], { icon: iconBARTIM }).addTo(map);
  map.setView([lat,lng],17);

  // Cari titik terdekat
  let terdekat = null;
  let jarakMin = 999999;

  dataESDM.forEach(d=>{
    const lat0 = parseAngka(d.lat_awal);
    const lng0 = parseAngka(d.lng_awal);
    if(!isNaN(lat0) && !isNaN(lng0)){
      const j = hitungJarak(lat,lng,lat0,lng0);
      if(j < jarakMin){
        jarakMin = j;
        terdekat = d;
      }
    }
  });

  formVerval.classList.remove("hidden");

  if(terdekat && jarakMin <= 100){
    tandaiBaris(terdekat.rowIndex);
    isiFormESDM(terdekat, lat, lng, jarakMin);
  } else {
    isiFormNonESDM(lat, lng);
  }
}

/* ======================= ISI FORM VERVAL ======================= */

function isiFormESDM(d, lat, lng, jarak){
  rowIndex.value = d.rowIndex;

  id_barang.value = d.id_barang || "";
  nama_kecamatan.value = d.nama_kecamatan || "";
  nama_desa_lokasi.value = d.nama_desa_lokasi || "";
  nama_kecamatan.readOnly = true;
  nama_desa_lokasi.readOnly = true;

  lat_awal.value = d.lat_awal || "";
  lng_awal.value = d.lng_awal || "";

  lat_verval.value = lat;
  lng_verval.value = lng;

  jarak.value = jarak.toFixed(1);
  status_validasi.value = jarak < 30 ? "Valid" : "Suspect / Bergeser";
}

function isiFormNonESDM(lat, lng){
  rowIndex.value = ""; // Trigger appendRow

  id_barang.value = "";
  nama_kecamatan.value = "";
  nama_desa_lokasi.value = "";
  nama_kecamatan.readOnly = false;
  nama_desa_lokasi.readOnly = false;

  lat_awal.value = "";
  lng_awal.value = "";

  lat_verval.value = lat;
  lng_verval.value = lng;

  jarak.value = "";
  status_validasi.value = "Non-ESDM";
}

/* ======================= KIRIM VERVAL (BASE64 + JSON) ======================= */

async function kirimVerval(){
  const fileInput = document.getElementById("foto_verval");
  const file = fileInput.files[0];

  if (!file){
    alert("Foto wajib diupload!");
    return;
  }

  // Convert ke base64
  const base64 = await new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });

  // Data dikirim ke Apps Script JSON
  const data = {
    action: "verval",
    rowIndex: rowIndex.value,
    id_barang: id_barang.value,
    nama_kecamatan: nama_kecamatan.value,
    nama_desa_lokasi: nama_desa_lokasi.value,
    lat_awal: lat_awal.value,
    lng_awal: lng_awal.value,
    status_validasi: status_validasi.value,
    petugas_verval: petugas.value,
    ket_wawancara: ket_wawancara.value,
    catatan_fisik: catatan.value,
    fotoBase64: base64
  };

  const res = await fetch(PROXY + SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });

  const json = await res.json();

  if(json.status === "success"){
    alert("VERVAL berhasil disimpan!");
    loadVerval(); // reload tabel hasil
  } else {
    alert("Gagal: " + json.message);
  }
}

/* ======================= HITUNG JARAK ======================= */

function hitungJarak(a,b,c,d){
  const R = 6371000, rad = Math.PI/180;
  const dLat = (c-a)*rad;
  const dLng = (d-b)*rad;
  const x = Math.sin(dLat/2)**2 +
            Math.cos(a*rad)*Math.cos(c*rad)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

/* ======================= LOAD DATA VERVAL ======================= */

function loadVerval(){
  fetch(SCRIPT_URL + `?action=listVerval`)
    .then(r=>r.json())
    .then(d=>{
      const rows = d.data || [];
      let html = "";

      rows.forEach(r=>{
        const foto = r.link_foto_verval
          ? `<a href="${r.link_foto_verval}" target="_blank">üì∑</a>`
          : "-";

        html += `
          <tr>
            <td>${r.id_barang || ""}</td>
            <td>${r.nama_desa_lokasi || ""}</td>
            <td>${r.status_validasi || ""}</td>
            <td>${r.petugas_verval || ""}</td>
            <td>${foto}</td>
          </tr>
        `;
      });

      tabelVerval.querySelector("tbody").innerHTML = html;
    })
    .catch(()=> console.log("Gagal load data verval"));
}

// pertama kali load
loadVerval();

</script>

<footer class="footer">
  Created by <b>SEPTERIADY NGUBEL, ST., M.Si.</b><br>
  DPUPRPERKIM Kabupaten Barito Timur
</footer>

</body>
</html>
