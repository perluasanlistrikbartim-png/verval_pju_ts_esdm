<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° VERVAL PJU TS KEMENTERIAN ESDM RI (TAHUN 2021, 2022, & 2023)‚Äî Kabupaten Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
/* ============================================================
   === PREMIUM MAX LIGHTNING UI ‚Äî DARK NEON INTERFACE ===
============================================================ */

body {
  margin: 0;
  background: radial-gradient(circle at center, #020216, #000010 70%, #000000);
  color: #e0f7ff;
  font-family: 'Segoe UI', sans-serif;
  overflow-x: hidden;
  position: relative;
}

/* ELECTRIC BACKGROUND */
#electricFX {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  opacity: .55;
  z-index: 0;
}

/* HEADER */
header {
  padding: 22px;
  text-align: center;
  background: linear-gradient(180deg, #021428, #000814 70%, #000);
  border-bottom: 2px solid #00eaff55;
  box-shadow: 0 0 25px #00eaff33 inset, 0 0 40px #0088ff22;
  position: relative;
  z-index: 5;
}

.header-flex {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 35px;
}

.logo-esdm, .logo-bartim {
  width: 85px;
  height: 85px;
  border-radius: 6px;
  background: #002233;
  padding: 6px;
  box-shadow: 0 0 20px #00eaff66;
  animation: glowLogo 6s ease-in-out infinite;
}
@keyframes glowLogo {
  0%,100% { filter: drop-shadow(0 0 10px #00eaff); }
  50% { filter: drop-shadow(0 0 25px #00eaffaa); }
}

.header-title {
  font-size: 1.6rem;
  font-weight: bold;
  text-shadow: 0 0 12px #00eaff, 0 0 25px #00aaff;
  margin-top: 10px;
}

.header-sub {
  font-size: 0.95rem;
  color: #a8deff;
  margin-top: 6px;
  text-shadow: 0 0 8px #0099ff88;
}

/* CONTAINER */
.container {
  padding: 15px;
  max-width: 960px;
  margin: auto;
  position: relative;
  z-index: 2;
}

/* INPUTS */
select, input, textarea, button {
  width: 100%;
  padding: 11px;
  border-radius: 10px;
  margin-top: 8px;
  border: none;
  font-size: 15px;
  background: #071a33;
  color: #cfefff;
  box-shadow: 0 0 12px #00eaff22 inset;
}
button {
  background: linear-gradient(90deg, #00eaff, #0088ff);
  color: #001;
  font-weight: bold;
  cursor: pointer;
  transition: 0.18s;
}
button:hover {
  box-shadow: 0 0 15px #00eaffcc;
  transform: translateY(-2px);
}

/* BOX */
.box {
  background: #071427cc;
  padding: 15px;
  border-radius: 14px;
  box-shadow: 0 0 20px #00eaff33 inset, 0 0 30px #0088ff22;
  margin-top: 18px;
}

/* TABLE */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 13px;
}
th, td {
  border: 1px solid #0c2b44;
  padding: 7px;
}
th {
  background: #0b2442;
  color: #aee7ff;
}
tr.updated {
  animation: blinkUpdate 1.2s ease-out;
}
@keyframes blinkUpdate {
  0% { background: #18ff9c; }
  100% { background: transparent; }
}

/* MAP */
#map {
  height: 360px;
  margin-top: 15px;
  border-radius: 14px;
  box-shadow: 0 0 20px #00eaff44;
}

/* LOADING SPINNER */
#loading {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: #001018dd;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  visibility: hidden;
}
.spinner {
  width: 70px;
  height: 70px;
  border: 8px solid #00eaff44;
  border-top-color: #00eaff;
  border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.readonly { background:#061325;color:#89a8c7; }
.hidden { display:none; }

</style>
</head>

<body>

<canvas id="electricFX"></canvas>

<div id="loading"><div class="spinner"></div></div>

<header>
  <div class="header-flex">
    <img src="esdm.png" class="logo-esdm">
    <div>
      <div class="header-title">‚ö° VERVAL PJU TS KEMENTERIAN ESDM RI 2021, 2022, & 2023‚Äì BARITO TIMUR ‚ö°</div>
      <div class="header-sub">Dinas PUPRPERKIM (2021 & 2023)‚Ä¢ Dishub (2022)</div>
    </div>
    <img src="bartim.png" class="logo-bartim">
  </div>
</header>

<div class="container">

<label>Pilih Tahun Perolehan</label>
<select id="tahunSelect">
  <option value="">-- Pilih Tahun --</option>
  <option>2021</option>
  <option>2022</option>
  <option>2023</option>
</select>

<button onclick="reloadHalaman()" style="background:#22e6a7;margin-top:10px">üîÑ Reload Halaman</button>

<div class="box">
  <b>DATA TARGET ESDM</b>
  <table id="tabelEsdm">
    <thead>
      <tr>
        <th>ID</th>
        <th>Kecamatan</th>
        <th>Desa</th>
        <th>Koordinat</th>
        <th>Status</th>
        <th>Wawancara</th>
        <th>Catatan</th>
        <th>Foto</th>
        <th>Waktu</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="map"></div>

<button onclick="ambilLokasi()">üìç Ambil Posisi GPS</button>

<label>Input Koordinat Manual</label>
<input id="latManual" placeholder="Latitude">
<input id="lngManual" placeholder="Longitude">
<button onclick="prosesManual()">Proses Manual</button>

<div class="box hidden" id="formVerval">
  <b>FORM VERVAL</b>

  <input id="rowIndex" class="readonly" readonly placeholder="Row Index">
  <input id="id_barang" class="readonly" readonly placeholder="ID Barang">
  <input id="nama_kecamatan" placeholder="Nama Kecamatan">
  <input id="nama_desa_lokasi" placeholder="Nama Desa/Lokasi">

  <input id="lat_awal" class="readonly" readonly placeholder="Lat Awal">
  <input id="lng_awal" class="readonly" readonly placeholder="Lng Awal">

  <input id="lat_verval" class="readonly" readonly placeholder="Lat Verval">
  <input id="lng_verval" class="readonly" readonly placeholder="Lng Verval">

  <input id="petugas" placeholder="Petugas Verifikasi">
  <input id="status_validasi" class="readonly" readonly placeholder="Status Validasi">
  <input id="jarak" class="readonly" readonly placeholder="Jarak (meter)">

  <select id="status_fisik">
    <option value="">Status Fisik</option>
    <option>Baik</option>
    <option>Rusak</option>
    <option>Hilang</option>
  </select>

  <input id="nama_narasumber" placeholder="Nama Narasumber">
  <textarea id="ket_wawancara" placeholder="Hasil Wawancara"></textarea>
  <textarea id="catatan" placeholder="Catatan Lapangan"></textarea>

  <label>Upload Foto</label>
  <input type="file" id="foto_verval" accept="image/*" capture="environment">

  <button id="btnSimpan" onclick="kirimVerval()">üíæ SIMPAN VERVAL</button>
</div>

<div class="box">
  <b>DATA HASIL VERVAL</b>
  <table id="tabelVerval">
    <thead>
      <tr>
        <th>ID</th>
        <th>Lokasi</th>
        <th>Status</th>
        <th>Petugas</th>
        <th>Foto</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

/* ================= KONFIG ================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzz7URJnz_3tqSCv2i-rUt4cgkFHwI6pH7JRidzSwkzczTIUlUO5f0NGs7yMCZZOvDTgg/exec";
const PROXY = "https://broad-queen-be12.perluasanlistrik-bartim.workers.dev/?url=";

/* ================= DOM ================= */
const tahunSelect = document.getElementById("tahunSelect");
const tabelEsdm   = document.getElementById("tabelEsdm");
const tabelVerval = document.getElementById("tabelVerval");
const loading     = document.getElementById("loading");
const formVerval  = document.getElementById("formVerval");

const rowIndex        = document.getElementById("rowIndex");
const id_barang       = document.getElementById("id_barang");
const nama_kecamatan  = document.getElementById("nama_kecamatan");
const nama_desa_lokasi= document.getElementById("nama_desa_lokasi");
const lat_awal        = document.getElementById("lat_awal");
const lng_awal        = document.getElementById("lng_awal");
const lat_verval      = document.getElementById("lat_verval");
const lng_verval      = document.getElementById("lng_verval");
const petugas         = document.getElementById("petugas");
const status_validasi = document.getElementById("status_validasi");
const status_fisik    = document.getElementById("status_fisik");
const nama_narasumber = document.getElementById("nama_narasumber");
const ket_wawancara   = document.getElementById("ket_wawancara");
const catatan         = document.getElementById("catatan");
const jarak           = document.getElementById("jarak");
const foto_verval     = document.getElementById("foto_verval");
const btnSimpan       = document.getElementById("btnSimpan");

/* ================= LOADING ================= */
function showLoad(){ loading.style.visibility="visible"; }
function hideLoad(){ loading.style.visibility="hidden"; }

/* ================= MAP ================= */
const map = L.map("map").setView([-2.13,115.10],10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const layerESDM = L.layerGroup().addTo(map);

const iconEsdm = L.icon({
  iconUrl:"https://raw.githubusercontent.com/perluasanlistrikbartim-png/verval_pju_ts_esdm/main/esdm.png",
  iconSize:[42,42], iconAnchor:[21,42]
});
const iconBartim = L.icon({
  iconUrl:"https://raw.githubusercontent.com/perluasanlistrikbartim-png/verval_pju_ts_esdm/main/bartim.png",
  iconSize:[42,42], iconAnchor:[21,42]
});

let markerSaya=null;
const cacheTahun={};

/* ================= EVENT ================= */
tahunSelect.addEventListener("change", loadTahun);

/* ================= LOAD TAHUN ================= */
function loadTahun(){
  const tahun = tahunSelect.value;

  tabelEsdm.querySelector("tbody").innerHTML="";
  layerESDM.clearLayers();
  if(!tahun) return;

  if(cacheTahun[tahun]){
    renderAll(cacheTahun[tahun]);
    return;
  }

  showLoad();
  const url = `${SCRIPT_URL}?action=listByYear&year=${tahun}`;

  fetch(PROXY + encodeURIComponent(url))
    .then(r=>r.json())
    .then(j=>{
      hideLoad();
      const data=j.data||[];
      cacheTahun[tahun]=data;
      renderAll(data);
    })
    .catch(e=>{
      hideLoad();
      alert("Gagal load data: "+e);
    });
}

/* ================= RENDER ================= */
function renderAll(data){
  renderTabel(data);
  renderPeta(data);
}
function renderTabel(data){
  tabelEsdm.querySelector("tbody").innerHTML = data.map(r=>`
    <tr id="row${r.rowIndex}">
      <td>${r.id_barang}</td>
      <td>${r.nama_kecamatan}</td>
      <td>${r.nama_desa_lokasi}</td>
      <td>${r.lat_awal?`<a target="_blank" href="https://maps.google.com/?q=${r.lat_awal},${r.lng_awal}">üìç</a>`:"-"}</td>
      <td>${r.status_validasi||""}</td>
      <td>${r.keterangan_wawancara||""}</td>
      <td>${r.catatan_fisik||""}</td>
      <td>${r.link_foto_verval?`<a target="_blank" href="${r.link_foto_verval}">üì∑</a>`:"-"}</td>
      <td>${r.waktu_simpan||""}</td>
    </tr>
  `).join("");
}
function renderPeta(data){
  layerESDM.clearLayers();
  data.forEach(r=>{
    if(!r.lat_awal||!r.lng_awal) return;
    L.marker([r.lat_awal,r.lng_awal],{icon:iconEsdm})
      .addTo(layerESDM)
      .on("click",()=>pilihTitik(r));
  });
}

/* ================= PILIH TITIK ================= */
function pilihTitik(d){
  formVerval.classList.remove("hidden");
  rowIndex.value=d.rowIndex;
  id_barang.value=d.id_barang;
  nama_kecamatan.value=d.nama_kecamatan;
  nama_desa_lokasi.value=d.nama_desa_lokasi;
  lat_awal.value=d.lat_awal;
  lng_awal.value=d.lng_awal;
}

/* ================= GPS & JARAK ================= */
window.ambilLokasi = function(){
  if(!navigator.geolocation) return alert("GPS tidak tersedia");
  navigator.geolocation.getCurrentPosition(p=>{
    prosesTitik(p.coords.latitude,p.coords.longitude);
  });
}
window.prosesManual = function(){
  const lat=parseFloat(document.getElementById("latManual").value);
  const lng=parseFloat(document.getElementById("lngManual").value);
  if(isNaN(lat)||isNaN(lng)) return alert("Koordinat tidak valid");
  prosesTitik(lat,lng);
}
function prosesTitik(lat,lng){
  if(markerSaya) map.removeLayer(markerSaya);
  markerSaya=L.marker([lat,lng],{icon:iconBartim}).addTo(map);
  map.setView([lat,lng],17);
  lat_verval.value=lat;
  lng_verval.value=lng;
  hitungJarak();
}
function hitungJarak(){
  if(!lat_awal.value||!lng_awal.value||!lat_verval.value||!lng_verval.value) return;
  const R=6371000;
  const dLat=(lat_verval.value-lat_awal.value)*Math.PI/180;
  const dLng=(lng_verval.value-lng_awal.value)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 +
    Math.cos(lat_awal.value*Math.PI/180)*Math.cos(lat_verval.value*Math.PI/180)*
    Math.sin(dLng/2)**2;
  jarak.value=Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))+" m";
}

/* ================= KIRIM VERVAL ================= */
window.kirimVerval = async function(){
  btnSimpan.disabled=true; btnSimpan.innerText="‚è≥ Menyimpan...";
  try{
    const file=foto_verval.files[0];
    if(!file) throw new Error("Foto wajib diupload");

    const base64=await new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result); r.onerror=rej;
      r.readAsDataURL(file);
    });

    const payload={
      action:"verval",
      rowIndex:rowIndex.value||"",
      tahun_perolehan:tahunSelect.value,
      id_barang:id_barang.value,
      nama_kecamatan:nama_kecamatan.value,
      nama_desa_lokasi:nama_desa_lokasi.value,
      lat_awal:lat_awal.value,
      lng_awal:lng_awal.value,
      lat_verval:lat_verval.value,
      lng_verval:lng_verval.value,
      petugas_verval:petugas.value,
      status_validasi:status_validasi.value||"Terverifikasi",
      status_fisik:status_fisik.value,
      nama_narasumber:nama_narasumber.value,
      keterangan_wawancara:ket_wawancara.value,
      catatan_fisik:catatan.value,
      jarak_selisih_meter:jarak.value,
      akurasi_gps_meter:0,
      metode_verifikasi:"GPS",
      fotoBase64:base64
    };

    showLoad();
    const res=await fetch(PROXY+encodeURIComponent(SCRIPT_URL),{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });
    const j=await res.json();
    hideLoad();
    if(j.status!=="success") throw new Error(j.message||"Gagal simpan");
    alert("‚úÖ Verval tersimpan");
    loadTahun(); // refresh data tahun aktif
  }catch(e){
    hideLoad();
    alert("‚ùå "+e.message);
  }finally{
    btnSimpan.disabled=false; btnSimpan.innerText="üíæ SIMPAN VERVAL";
  }
}

/* ================= UTIL ================= */
window.reloadHalaman = function(){ location.reload(); }

}); // DOMContentLoaded
</script>


<!-- ============================================================
     ‚ö° FOOTER PREMIUM
============================================================ -->
<footer style="
  margin-top:40px;
  padding:15px;
  text-align:center;
  background:#0b1222;
  border-top:2px solid #113366;
  color:#7fc7ff;
  font-weight:bold;
  text-shadow:0 0 10px #0088ff;
  box-shadow:0 0 18px #00d9ff55 inset;
">
  ¬© 2025 ‚Äî VERVAL PJU TS ‚Ä¢ Dinas Pertambangan & Energi ESDM Barito Timur
</footer>


</body>
</html>
